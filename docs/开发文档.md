# 汉兜二次开发文档

## 项目概述

本文档基于汉字版Wordle项目进行二次开发，主要添加游戏模式选择功能，支持每日一题和无尽模式，同时优化用户体验。

### 开发目标
- 删除严格模式，简化游戏逻辑
- 添加主界面模式选择功能
- 实现无尽模式的连续挑战
- 优化分享功能，移除社交媒体选项

## 需求分析

### 功能需求
1. **模式选择界面**
   - 美观的模式选择卡片设计
   - 清晰的功能说明和特色展示
   - 响应式布局适配

2. **每日一题模式**
   - 保持现有游戏逻辑不变
   - 保留历史记录和统计功能
   - 维持原有的时间限制机制

3. **无尽模式**
   - 随机成语生成机制
   - 支持连续挑战功能
   - 再来一词按钮实现
   - 轮次统计和显示

4. **分享功能优化**
   - 移除微博分享选项
   - 移除推特分享选项
   - 保留微信分享和复制链接功能
   - 适配不同模式的分享内容

### 非功能需求
- **性能要求**: 模式切换响应时间 < 500ms
- **兼容性**: 支持主流浏览器和移动设备
- **可维护性**: 代码结构清晰，模块化设计
- **可扩展性**: 支持未来添加新游戏模式

## 技术架构

### 整体架构
```
┌─────────────────────────────────────┐
│            App.vue                  │
│  ┌───────────────────────────────┐  │
│  │      GameModeSelector         │  │
│  │  (模式选择组件)               │  │
│  └─────────────┬─────────────────┘  │
│                │                      │
│  ┌─────────────▼─────────────────┐    │
│  │         Play.vue             │    │
│  │  ┌────────────────────────┐  │    │
│  │  │   每日模式  │  无尽模式  │  │    │
│  │  │   (Daily)   │ (Endless) │  │    │
│  │  └─────────────┴────────────┘  │    │
│  └────────────────────────────────┘    │
└─────────────────────────────────────┘
```

### 核心模块
1. **模式管理模块** (`mode.ts`)
   - 负责模式切换逻辑
   - 提供模式状态管理
   - 支持模式判断和状态重置

2. **无尽模式引擎** (`endless.ts`)
   - 管理无尽模式状态
   - 处理轮次切换逻辑
   - 协调随机成语生成

3. **随机成语生成器** (`randomIdiom.ts`)
   - 成语数据管理和缓存
   - 随机选择算法实现
   - 去重和循环使用机制

## 开发环境

### 技术栈
- **前端框架**: Vue 3.2.45 + Composition API
- **构建工具**: Vite 4.x
- **样式方案**: UnoCSS 0.47.x
- **状态管理**: VueUse + reactive
- **开发语言**: TypeScript 4.9.x
- **图标库**: Iconify

### 项目结构
```
handle-main/
├── src/
│   ├── components/          # 组件目录
│   │   ├── GameModeSelector.vue    # 新增：模式选择
│   │   ├── Play.vue               # 修改：游戏主组件
│   │   ├── ShareButton.vue        # 修改：分享组件
│   │   ├── CharBlock.vue          # ✅ 直接复用：字符块组件
│   │   ├── WordBlocks.vue         # ✅ 直接复用：词语块组件
│   │   ├── Navbar.vue             # ✅ 直接复用：导航栏
│   │   ├── Modal.vue              # ✅ 直接复用：模态框
│   │   └── ...                    # ✅ 其他UI组件直接复用
│   ├── logic/               # 逻辑模块
│   │   ├── mode.ts          # 新增：模式管理
│   │   ├── endless.ts       # 新增：无尽模式
│   │   ├── randomIdiom.ts   # 新增：随机成语
│   │   ├── check.ts         # ✅ 直接复用：成语验证逻辑
│   │   ├── utils.ts         # ✅ 直接复用：工具函数（拼音解析、答案检查等）
│   │   ├── idioms.ts        # ✅ 直接复用：成语数据处理
│   │   ├── constants.ts     # ✅ 直接复用：游戏常量
│   │   ├── types.ts         # ✅ 直接复用：类型定义
│   │   └── ...              # ✅ 其他逻辑模块直接复用
│   ├── styles/              # 样式文件
│   │   └── main.css         # ✅ 直接复用：基础样式
│   ├── main.ts              # ✅ 直接复用：应用入口（小修改）
│   ├── storage.ts           # 修改：删除严格模式相关
│   ├── state.ts             # ✅ 直接复用：状态管理
│   └── App.vue              # 修改：添加模式选择逻辑
├── public/                  # 静态资源（全部复用）
├── test/                    # 测试文件（全部复用）
├── tools/                   # 工具脚本（全部复用）
├── package.json             # ✅ 直接复用：项目配置
├── vite.config.ts           # ✅ 直接复用：构建配置
├── unocss.config.ts         # ✅ 直接复用：样式配置
└── tsconfig.json            # ✅ 直接复用：TypeScript配置
```

### 代码复用分析
**90%+ 代码可直接复用**：
- ✅ **核心游戏逻辑**: 成语验证、拼音解析、工具函数等
- ✅ **UI组件**: 字符块、词语块、导航栏、模态框等
- ✅ **样式配置**: UnoCSS配置、基础样式、主题变量
- ✅ **构建配置**: Vite配置、TypeScript配置、依赖管理
- ✅ **数据层**: 成语数据、类型定义、常量配置

**仅需修改10%-代码**：
- 🛠️ **主应用逻辑**: 添加模式选择和状态管理
- 🛠️ **游戏主组件**: 支持无尽模式的轮次切换
- 🛠️ **分享功能**: 简化分享选项，移除社交媒体
- 🛠️ **存储管理**: 删除严格模式相关代码

### 关键复用文件清单
**完全复用（无需修改）**：
```
src/logic/check.ts          # 成语验证逻辑
src/logic/utils.ts          # 工具函数（拼音解析、答案检查）
src/logic/idioms.ts         # 成语数据处理
src/logic/constants.ts      # 游戏常量
src/logic/types.ts          # 类型定义
src/components/CharBlock.vue     # 字符块组件
src/components/WordBlocks.vue    # 词语块组件
src/components/Navbar.vue        # 导航栏
src/components/Modal.vue       # 模态框
src/styles/main.css         # 基础样式
vite.config.ts             # 构建配置
unocss.config.ts           # 样式配置
package.json               # 项目配置
```

**需要修改（约10%代码）**：
```
src/App.vue                 # 添加模式选择界面
src/components/Play.vue     # 支持无尽模式轮次切换
src/components/ShareButton.vue  # 移除社交媒体分享
src/storage.ts              # 删除严格模式相关
src/main.ts                 # 可选的模式初始化
```

**全新创建（约5个文件）**：
```
src/logic/mode.ts           # 模式管理
src/logic/endless.ts        # 无尽模式引擎
src/logic/randomIdiom.ts    # 随机成语生成器
src/components/GameModeSelector.vue  # 模式选择界面
```

## 开发步骤

### 第一阶段：基础改造

#### 1.1 删除严格模式
**修改文件**: `src/storage.ts`
```typescript
// 删除以下代码
const strictMode = useStorage('hanziwordle-strict', false)
export const useStrict = computed(() => strictMode.value)
```

**修改文件**: `src/components/Play.vue`
- 移除严格模式切换按钮
- 删除严格模式相关逻辑
- 简化状态管理代码

#### 1.2 创建模式管理模块
**新建文件**: `src/logic/mode.ts`
```typescript
import { ref, computed } from 'vue'

export type GameMode = 'daily' | 'endless'

const currentMode = ref<GameMode>('daily')

export function switchMode(mode: GameMode) {
  currentMode.value = mode
}

export const isDailyMode = computed(() => currentMode.value === 'daily')
export const isEndlessMode = computed(() => currentMode.value === 'endless')
```

#### 1.3 创建无尽模式引擎
**新建文件**: `src/logic/endless.ts`
```typescript
import { ref, computed } from 'vue'
import { getRandomIdiom } from './randomIdiom'

const endlessRound = ref(1)
const currentWord = ref('')
const currentTries = ref<string[]>([])
const isRoundFinished = ref(false)

export function initEndlessMode() {
  startNewRound()
}

export function startNewRound() {
  currentWord.value = getRandomIdiom()
  currentTries.value = []
  isRoundFinished.value = false
  endlessRound.value++
}
```

### 第二阶段：界面开发

#### 2.1 创建模式选择组件
**新建文件**: `src/components/GameModeSelector.vue`
```vue
<template>
  <div class="mode-selector min-h-screen flex items-center justify-center">
    <div class="mode-cards grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto p-8">
      
      <!-- 每日一题卡片 -->
      <div class="mode-card daily-card" @click="selectMode('daily')">
        <div class="card-icon text-6xl mb-4">📅</div>
        <h2 class="text-2xl font-bold mb-2">每日一题</h2>
        <p class="text-gray-600 mb-6">每天一个成语，与全球玩家同步挑战</p>
        <div class="features space-y-2">
          <div class="feature flex items-center">
            <span class="mr-2">✓</span>
            <span>每日更新</span>
          </div>
          <div class="feature flex items-center">
            <span class="mr-2">✓</span>
            <span>全球同步</span>
          </div>
          <div class="feature flex items-center">
            <span class="mr-2">✓</span>
            <span>历史记录</span>
          </div>
        </div>
      </div>
      
      <!-- 无尽模式卡片 -->
      <div class="mode-card endless-card" @click="selectMode('endless')">
        <div class="card-icon text-6xl mb-4">♾️</div>
        <h2 class="text-2xl font-bold mb-2">无尽模式</h2>
        <p class="text-gray-600 mb-6">连续挑战，不断突破自我极限</p>
        <div class="features space-y-2">
          <div class="feature flex items-center">
            <span class="mr-2">✓</span>
            <span>无限挑战</span>
          </div>
          <div class="feature flex items-center">
            <span class="mr-2">✓</span>
            <span>即时反馈</span>
          </div>
          <div class="feature flex items-center">
            <span class="mr-2">✓</span>
            <span>连续记录</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { defineEmits } from 'vue'
import { switchMode } from '~/logic/mode'

const emit = defineEmits<{
  modeSelected: [mode: 'daily' | 'endless']
}>()

function selectMode(mode: 'daily' | 'endless') {
  switchMode(mode)
  emit('modeSelected', mode)
}
</script>

<style scoped>
.mode-card {
  @apply bg-white dark:bg-gray-800 rounded-xl p-8 shadow-lg hover:shadow-xl transition-all duration-300 border-2 border-transparent hover:border-primary cursor-pointer;
}

.daily-card:hover {
  @apply border-blue-500;
}

.endless-card:hover {
  @apply border-green-500;
}
</style>
```

#### 2.2 修改主应用组件
**修改文件**: `src/App.vue`
```vue
<template>
  <main font-sans text="center gray-700 dark:gray-300" select-none>
    <!-- 新增：模式选择 -->
    <GameModeSelector 
      v-if="!modeSelected" 
      @mode-selected="handleModeSelected" 
    />
    
    <!-- 原有游戏内容 -->
    <template v-else>
      <!-- 原有内容保持不变 -->
      <NotTodayBanner v-if="dayNo < daySince && isDailyMode" />
      <Navbar />
      <div p="4">
        <NoQuizToday v-if="!answer.word && isDailyMode" />
        <NoFuturePlay v-else-if="dayNo > daySince && !isDev && isDailyMode" />
        <NoPastPlay v-else-if="daySince - dayNo > DAYS_PLAY_BACK && !isDev && isDailyMode" />
        <Play v-else :mode="currentMode" @round-complete="handleRoundComplete" />
      </div>
      <ModalsLayer />
      <Confetti />
    </template>
  </main>
</template>

<script setup lang="ts">
// 新增导入
import { ref } from 'vue'
import { currentMode, isDailyMode } from '~/logic/mode'
import { initEndlessMode } from '~/logic/endless'

// 新增状态
const modeSelected = ref(false)

// 新增方法
function handleModeSelected(mode: 'daily' | 'endless') {
  modeSelected.value = true
  if (mode === 'endless') {
    initEndlessMode()
  }
}

function handleRoundComplete() {
  // 处理轮次完成逻辑
}
</script>
```

#### 2.3 修改游戏主组件
**修改文件**: `src/components/Play.vue`
```vue
<template>
  <!-- 原有模板内容 -->
  
  <!-- 新增：无尽模式完成界面 -->
  <Transition name="fade-in">
    <div v-if="isEndlessMode && isFinished" class="endless-complete">
      <div class="complete-message text-2xl mb-4">
        🎉 恭喜完成第 {{ endlessRound }} 轮！
      </div>
      <button 
        class="next-round-btn bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-dark transition-colors"
        @click="startNextRound"
      >
        再来一词
      </button>
    </div>
  </Transition>
</template>

<script setup lang="ts">
// 新增导入
import { isEndlessMode } from '~/logic/mode'
import { startNewRound, endlessRound } from '~/logic/endless'

const props = defineProps<{
  mode: 'daily' | 'endless'
}>()

const emit = defineEmits<{
  nextRound: []
}>()

function startNextRound() {
  if (props.mode === 'endless') {
    startNewRound()
    resetGameState()
    emit('nextRound')
  }
}

function resetGameState() {
  // 重置游戏状态
  input.value = ''
  inputValue.value = ''
  tries.value = []
  meta.value = {}
}
</script>
```

### 第三阶段：分享功能优化

#### 3.1 修改分享组件
**修改文件**: `src/components/ShareButton.vue`
```vue
<template>
  <div class="share-buttons flex gap-2">
    <!-- 保留微信分享 -->
    <button 
      v-if="wechat" 
      @click="shareToWechat" 
      class="share-btn wechat bg-green-500 text-white px-4 py-2 rounded"
    >
      微信分享
    </button>
    
    <!-- 保留复制链接 -->
    <button 
      @click="copyLink" 
      class="share-btn copy bg-blue-500 text-white px-4 py-2 rounded"
    >
      复制链接
    </button>
    
    <!-- 删除以下分享选项 -->
    <!--
    <button v-if="weibo" @click="shareToWeibo" class="share-btn weibo">
      微博分享
    </button>
    <button v-if="twitter" @click="shareToTwitter" class="share-btn twitter">
      推特分享
    </button>
    -->
  </div>
</template>

<script setup lang="ts">
// 删除微博和推特相关方法
// const shareToWeibo = () => { ... }
// const shareToTwitter = () => { ... }
</script>
```

## 测试方案

### 功能测试
1. **模式切换测试**
   - 测试模式选择界面显示
   - 测试模式切换功能
   - 验证不同模式的状态隔离

2. **无尽模式测试**
   - 测试随机成语生成
   - 测试轮次切换功能
   - 测试再来一词按钮

3. **分享功能测试**
   - 验证分享选项显示
   - 测试微信分享功能
   - 测试复制链接功能

### 性能测试
1. **响应时间测试**
   - 模式切换响应时间 < 500ms
   - 成语加载时间 < 1s
   - 界面渲染流畅度

2. **内存测试**
   - 检查内存泄漏
   - 验证状态清理
   - 长时间运行稳定性

### 兼容性测试
1. **浏览器兼容**
   - Chrome, Firefox, Safari, Edge
   - 移动端浏览器

2. **设备兼容**
   - 桌面端响应式
   - 移动端适配
   - 平板设备显示

## 部署方案

### 构建配置
保持现有Vite配置，无需特殊调整：
```bash
npm run build
```

### 环境变量
可选添加功能开关：
```bash
# .env.production
VITE_ENABLE_ENDLESS_MODE=true
VITE_DISABLE_STRICT_MODE=true
```

### 部署步骤
1. 本地构建项目
2. 测试构建结果
3. 部署到服务器
4. 验证线上功能

## 代码复用关键点记录

### 复用统计
- **完全复用**: 约85%代码无需修改
- **轻度修改**: 约10%代码需要调整
- **全新创建**: 约5%代码需要新增

### 高价值复用组件
1. **核心逻辑层**: `check.ts`, `utils.ts`, `idioms.ts` - 成语验证和工具函数
2. **UI组件层**: `CharBlock.vue`, `WordBlocks.vue` - 游戏界面核心组件
3. **样式配置**: `unocss.config.ts`, `main.css` - 视觉一致性保证
4. **构建配置**: `vite.config.ts`, `tsconfig.json` - 开发环境稳定

### 必须修改的关键点
1. **删除严格模式**: `storage.ts`中移除相关代码
2. **添加模式选择**: `App.vue`中集成模式选择界面
3. **支持无尽模式**: `Play.vue`中添加轮次管理
4. **优化分享功能**: `ShareButton.vue`中移除社交媒体选项

### 新增核心模块
1. **模式管理** (`mode.ts`): 统一管理模式状态
2. **无尽模式引擎** (`endless.ts`): 处理连续挑战逻辑
3. **随机成语生成器** (`randomIdiom.ts`): 智能成语选择
4. **模式选择界面** (`GameModeSelector.vue`): 美观的模式选择UI

### 复用优势
- **稳定性**: 复用经过验证的核心逻辑
- **一致性**: 保持UI风格和交互体验统一
- **效率性**: 大幅减少开发时间和成本
- **维护性**: 降低后续维护复杂度

### 详细复用分析
详见《代码复用分析.md》文档，包含完整的文件清单、复用策略和风险评估。

## 代码复用策略详解

### 高复用性组件（无需修改）
**90%以上代码可直接复用**，主要包括：

#### 核心逻辑模块
- ✅ **成语验证** (`check.ts`): 成语有效性检查逻辑完全复用
- ✅ **工具函数** (`utils.ts`): 拼音解析、答案检查、状态判断等函数
- ✅ **成语数据** (`idioms.ts`): 成语列表、多音字处理等数据层
- ✅ **类型定义** (`types.ts`): 所有接口和类型定义保持不变
- ✅ **游戏常量** (`constants.ts`): WORD_LENGTH、TRIES_LIMIT等常量

#### UI组件层
- ✅ **字符块组件** (`CharBlock.vue`): 单个字符显示和状态渲染
- ✅ **词语块组件** (`WordBlocks.vue`): 词语网格布局和动画效果
- ✅ **导航栏组件** (`Navbar.vue`): 顶部导航和功能按钮
- ✅ **模态框组件** (`Modal.vue`): 弹窗和对话框组件
- ✅ **输入组件**: 拼音输入、键盘交互等现有组件

#### 样式和配置
- ✅ **UnoCSS配置** (`unocss.config.ts`): 原子类样式系统
- ✅ **基础样式** (`styles/main.css`): 主题变量、动画、响应式样式
- ✅ **Vite配置** (`vite.config.ts`): 构建工具配置
- ✅ **TypeScript配置** (`tsconfig.json`): 类型检查配置

### 需要修改的组件（10%修改）

#### 轻度修改（添加模式支持）
- 🛠️ **主应用** (`App.vue`): 添加模式选择界面渲染逻辑
- 🛠️ **游戏主组件** (`Play.vue`): 添加无尽模式状态管理
- 🛠️ **主入口** (`main.ts`): 可选的模式初始化逻辑

#### 中度修改（功能调整）
- 🛠️ **存储管理** (`storage.ts`): 删除严格模式相关代码
- 🛠️ **分享组件** (`ShareButton.vue`): 移除微博/推特分享选项

### 全新创建组件（约5个文件）
- 🆕 **模式管理** (`mode.ts`): 模式切换和状态管理
- 🆕 **无尽模式引擎** (`endless.ts`): 轮次管理和状态维护
- 🆕 **随机成语生成器** (`randomIdiom.ts`): 智能成语选择和去重
- 🆕 **模式选择界面** (`GameModeSelector.vue`): 美观的模式选择UI

### 复用优势
1. **稳定性**: 复用经过验证的核心逻辑，降低bug风险
2. **一致性**: 保持UI风格和交互体验的一致性
3. **开发效率**: 大幅减少开发时间，专注新模式逻辑
4. **维护性**: 减少代码重复，便于后续维护

### 复用注意事项
1. **依赖检查**: 确保复用组件的依赖项都已满足
2. **状态隔离**: 不同模式间的状态需要正确隔离
3. **样式冲突**: 新增组件样式不要影响现有样式
4. **性能考虑**: 避免不必要的重复渲染和数据加载

## 维护指南

### 代码规范
1. **TypeScript规范**
   - 所有函数添加类型注解
   - 使用接口定义数据结构
   - 避免使用any类型

2. **Vue规范**
   - 使用Composition API
   - 组件命名采用PascalCase
   - 逻辑复用使用composables

3. **样式规范**
   - 使用UnoCSS原子类
   - 避免内联样式
   - 响应式设计优先

### 性能优化
1. **代码分割**
   - 模式选择组件懒加载
   - 成语数据异步加载
   - 路由级别的代码分割

2. **缓存策略**
   - 成语数据内存缓存
   - 模式选择状态缓存
   - 游戏状态按需重置

### 监控指标
1. **性能指标**
   - 页面加载时间
   - 模式切换时间
   - 用户交互响应时间

2. **错误指标**
   - JavaScript错误率
   - API调用失败率
   - 用户体验问题报告

## 扩展规划

### 短期扩展（1-3个月）
1. **更多游戏模式**
   - 限时挑战模式
   - 多人对战模式
   - 主题成语模式

2. **功能增强**
   - 成语解释显示
   - 发音功能
   - 收藏夹功能

### 长期规划（3-12个月）
1. **社交功能**
   - 好友系统
   - 排行榜
   - 挑战功能

2. **个性化**
   - 用户偏好设置
   - 智能推荐
   - 学习路径

3. **商业化**
   - 会员功能
   - 广告集成
   - 付费内容

## 总结

本次二次开发在保持原有项目架构的基础上，通过模块化的方式添加了游戏模式选择功能。整个开发过程遵循渐进式增强的原则，确保现有功能不受影响的同时，为用户提供更丰富的游戏体验。

开发文档涵盖了从需求分析到部署维护的完整流程，为后续开发和维护提供了详细的指导。通过合理的架构设计和代码规范，确保了项目的可扩展性和可维护性。